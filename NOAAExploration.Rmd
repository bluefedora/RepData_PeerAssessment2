## Effects of Severe Weather on Property and Population in the US for the Time Period 1950 to November 2011

### Synopsis

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

This analysis involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

The data was downloaded and read into a data.frame.  The data.frame was subsetted into a DF that contained the pertinent data.  Some minor cleanup was performed and the data then summarized and the top 10 event types for damage and casualties are listed and graphed for your convenience.

### Data Processing
#### Setup the needed libraries and environment.

```{r setEnvironment}
library(utils)
library(plyr)
opts_chunk$set(echo=TRUE, fig.width=6, fig.height=6)
```

Download the database along with the documentation files

#### Download data and documentation files
```{r 'downloadData'}
blueFedoraDownload <- function (fileURL, destfile, method="auto", quiet=TRUE) {
    if(!file.exists("./data")) {
        dir.create("./data")
    }
    destfile <- paste0("./data/", destfile)
    if (!file.exists(destfile)) {
        if (grepl("https:", fileURL) & method=="auto") {
            method <- "curl"
        }
        print(sprintf("DL file: %s on %s", destfile, date()))
        download.file(fileURL, destfile=destfile, method=method, quiet=quiet)
    }
}
#download data file
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
dest <- "StormData.bz2"
blueFedoraDownload(url, dest)

#download storm data documentation
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf"
dest <- "pd0101600tcurr.pdf"
blueFedoraDownload(url, dest)

#download storm events FAQ
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf"
dest <- "StormEventsFAQ.pdf"
blueFedoraDownload(url, dest)
```

#### Read data into StormData data.frame

```{r 'readData', cache=TRUE}
StormData <- read.csv("./data/StormData.bz2")
```
Exploring the storm data:
```{r 'exploreStormData'}
dim(StormData)
names(StormData)
#str(StormData)
#head(StormData)
```

The documentation refers to "Summary" EVTYPEs.  These are not "storms" as such and will be removed from the data.set.  Also only the pertinent columns, EVTYPE, CROPDMG, CROPDMGEXP, PROPDMG, PROPDMGEXP, FATALITIES and INJURIES will be included.

```{r removeSummaries}
workData <- subset(StormData, !grepl("Summary", StormData$EVTYPE), select=c('EVTYPE', 'CROPDMG', 'CROPDMGEXP', 'PROPDMG', 'PROPDMGEXP', 'FATALITIES', 'INJURIES'))
```

Doing a summary of the exponent data for crops and property damage, CROPDMGEXP and PROPMGEXP variables, we get:

```{r summaryData}
summary(workData$CROPDMGEXP)
summary(workData$PROPDMGEXP)
```

The NOAA documentation states that the exponent values of the crop and property damage (CROPDMGEXP and PROPDMGEXP) are alpha and are: "K" for thousands, "M" for millions, "B" for billions, other values such as numbers and symbols are not defined.

It may be a reasonable assumption that the sequence 0 thru 8 would be powers of ten and "H" is hundreds but they not mentioned in the documentation. Other characters such as "+", "-", "?" and lower case m, k, h are also not mentioned in the documentation.  This analyis in general takes a conservative approach toward the data, does NOT make assumptions and will ignore all of these undocumented exponent characters.

New fields for the crop and property damage exponents, CEXP and PEXP, will be set to the proper power of ten based on the valid exponent value.  An invalid exponent value will result in a value NA that results in that observation being excluded from the results.

```{r prepareMeltAggregate}
#first fill the EXP value with NAs
workData$CEXP <- NA
workData$PEXP <- NA

#then set the exponents to the proper power of ten based on the letters K, M, B

workData$CEXP <- ifelse(grepl('K', workData$CROPDMGEXP), 10^3, workData$CEXP)
workData$CEXP <- ifelse(grepl('M', workData$CROPDMGEXP), 10^6, workData$CEXP)
workData$CEXP <- ifelse(grepl('B', workData$CROPDMGEXP), 10^9, workData$CEXP)

workData$PEXP <- ifelse(grepl('K', workData$PROPDMGEXP), 10^3, workData$PEXP)
workData$PEXP <- ifelse(grepl('M', workData$PROPDMGEXP), 10^6, workData$PEXP)
workData$PEXP <- ifelse(grepl('B', workData$PROPDMGEXP), 10^9, workData$PEXP)
summary(workData)

#calculate the property damages to crops and property
workData$CROPDMG <- workData$CROPDMG * workData$CEXP
workData$PROPDMG <- workData$PROPDMG * workData$PEXP

totals <- ddply(workData, ~ EVTYPE, summarize,
                CropDmgImpact=sum(CROPDMG, na.rm=TRUE),
                PropDmgImpact=sum(PROPDMG, na.rm=TRUE),
                TotalDmgImpact=sum(CROPDMG, PROPDMG, na.rm=TRUE),
                Fatalities=sum(FATALITIES, na.rm=TRUE),
                Injuries=sum(INJURIES, na.rm=TRUE),
                TotalHealth=sum(FATALITIES, INJURIES, na.rm=TRUE))
summary(totals)

#dam <- melt(workData, id.vars="EVTYPE", 
#                measure.vars=c("PROPDMG", "CROPDMG"))
#hea <- melt(workData, id.vars="EVTYPE",
#                measure.vars=c("FATALITIES", "INJURIES"))
#
#damage <- ddply(dam, ~ EVTYPE, summarize, value=sum(value, na.rm=TRUE))
#health <- ddply(hea, ~ EVTYPE, summarize, value=sum(value, na.rm=TRUE))
#
#summary(damage)
#summary(health)
```

### Results

* Health Impact Reports

```{r healthReports}
print("Top fifteen fatalities event types")
print(totals[order(-totals$Fatalities),c(1,5)][1:15, ], row.names=FALSE)

print("Top fifteen injuries event types")
print(totals[order(-totals$Injuries),c(1,6)][1:15, ], row.names=FALSE)

print("Top fifteen total health impact event types")
print(totals[order(-totals$TotalHealth),c(1,7)][1:15, ], row.names=FALSE)
```

We see from the above printed table that the top threats for human fatalities are , and .  The top threats for human injuries are , and .  The top combined health threats come from , and .

We notice that there are event types which are similar; e.g., Hurricane and Hurrican/Typhoon and Flood, River Flood and Flash Flood.  We have no evidence that these event types are actually the same and made the decision to not combine them.

* Damage Impact Reports

```{r damageReports}
print("Top fifteen crop damage event types")
print(totals[order(-totals$CropDmgImpact),c(1,2)][1:15, ], row.names=FALSE)

print("Top fifteen property damage event types")
print(totals[order(-totals$PropDmgImpact), c(1,3)][1:15, ], row.names=FALSE)

print("Top fifteen total damage (crop + property)")
print(totals[order(-totals$TotalDmgImpact), c(1,4)][1:15, ], row.names=FALSE)
```


### Environment
```{r 'sessionInfo'}
sessionInfo()
```